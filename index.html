<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal - WeOne</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #343a40;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding-bottom: 60px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .app-container {
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 15px 0;
            margin-bottom: 15px;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 15px;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 12px 15px;
            border-bottom: none;
        }
        
        .card-body {
            padding: 15px;
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-top: none;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .badge {
            font-weight: 500;
            padding: 5px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        
        .month-display {
            font-size: 1.1rem;
            font-weight: bold;
            min-width: 150px;
            text-align: center;
            margin: 0 10px;
        }
        
        .month-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .status-badge {
            display: inline-block;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            text-align: center;
            line-height: 22px;
            font-weight: bold;
            color: white;
            font-size: 0.7rem;
        }
        
        .status-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 6px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.8rem;
        }
        
        .status-color {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 20px;
        }
        
        .payslip {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ddd;
            padding: 15px;
            font-family: Arial, sans-serif;
            position: relative;
        }
        
        .payslip-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #333;
        }
        
        .payslip-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .payslip-period {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .payslip-section {
            margin-bottom: 15px;
        }
        
        .payslip-section-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
        }
        
        .payslip-row {
            display: flex;
            margin-bottom: 3px;
            font-size: 0.85rem;
        }
        
        .payslip-label {
            flex: 1;
            font-weight: bold;
        }
        
        .payslip-value {
            flex: 2;
        }
        
        .payslip-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        .payslip-table th {
            background-color: #f2f2f2;
            text-align: left;
            padding: 6px;
            border: 1px solid #ddd;
        }
        
        .payslip-table td {
            padding: 6px;
            border: 1px solid #ddd;
        }
        
        .payslip-footer {
            margin-top: 20px;
            padding-top: 8px;
            border-top: 1px solid #333;
            text-align: center;
            font-size: 0.75rem;
        }
        
        .payslip-signature {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .payslip-signature-line {
            width: 120px;
            border-top: 1px solid #333;
            text-align: center;
            padding-top: 3px;
            font-size: 0.8rem;
        }
        
        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.8rem;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
            width: 100%;
            max-width: 100px;
        }
        
        .nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .nav-btn.active {
            color: var(--primary-color);
            background-color: rgba(52, 58, 64, 0.1);
        }
        
        .tab-content {
            padding-bottom: 60px;
        }
        
        /* Employee info summary */
        .employee-summary {
            background-color: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .employee-summary-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .employee-summary-label {
            flex: 1;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .employee-summary-value {
            flex: 2;
        }
        
        .absent-text {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .payslip, .payslip * {
                visibility: visible;
            }
            .payslip {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 15px;
                border: none;
                background-color: white;
                page-break-after: always;
            }
            .no-print, .no-print * {
                display: none !important;
            }
        }
        
        @media (max-width: 576px) {
            .login-container {
                padding: 20px;
                margin: 20px;
            }
            
            .table {
                font-size: 0.8rem;
            }
            
            .table th, .table td {
                padding: 6px;
            }
            
            .status-legend {
                gap: 5px;
            }
            
            .status-item {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .month-display {
                font-size: 1rem;
                min-width: 120px;
            }
            
            .nav-btn {
                font-size: 0.7rem;
            }
            
            .nav-btn i {
                font-size: 1rem;
            }
            
            .payslip-title {
                font-size: 1rem;
            }
            
            .payslip-period {
                font-size: 0.8rem;
            }
            
            .payslip-row {
                flex-direction: column;
                font-size: 0.8rem;
            }
            
            .payslip-label, .payslip-value {
                flex: auto;
            }
            
            .payslip-signature {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .payslip-signature-line {
                width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div class="loading">
        <div class="loading-content">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading data...</p>
        </div>
    </div>

    <!-- Login Container -->
    <div class="login-container" id="login-container">
        <div class="text-center mb-4">
            <img src="weoneimage.jpg" height="200px" width="200px" alt="WeOne Logo" class="mb-3">
            <h3>Employee Portal</h3>
            <p class="text-muted">View your roster, attendance and payslips</p>
        </div>
        
        <form id="login-form">
            <div class="mb-3">
                <label for="employee-id" class="form-label">WE ONE ID or EK ID</label>
                <input type="text" class="form-control" id="employee-id" placeholder="Enter your ID" required>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="remember-me">
                <label class="form-check-label" for="remember-me">Remember me</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="app-container">
        <!-- Header -->
        <div class="header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-8">
                        <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i> <span id="employee-name"></span></h5>
                        <small class="text-white-50" id="employee-designation"></small>
                    </div>
                    <div class="col-4 text-end">
                        <button id="logout-btn" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Employee Summary -->
            <div class="employee-summary">
                <div class="employee-summary-row">
                    <div class="employee-summary-label">WE ONE ID:</div>
                    <div class="employee-summary-value" id="info-weone-id"></div>
                </div>
                <div class="employee-summary-row">
                    <div class="employee-summary-label">Department:</div>
                    <div class="employee-summary-value" id="info-department"></div>
                </div>
                <div class="employee-summary-row">
                    <div class="employee-summary-label">Area:</div>
                    <div class="employee-summary-value" id="info-area"></div>
                </div>
            </div>

            <!-- Month Selector -->
            <div class="month-selector">
                <button id="prev-month-btn" class="month-btn" title="Previous Month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="month-display" class="month-display">April 2025</div>
                <button id="next-month-btn" class="month-btn" title="Next Month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="employeeTabsContent">
                <!-- Roster Tab -->
                <div class="tab-pane fade show active" id="roster-tab-pane" role="tabpanel" aria-labelledby="roster-tab" tabindex="0">
                    <!-- Status Legend -->
                    <div class="status-legend">
                        <div class="status-item">
                            <div class="status-color" style="background-color: #e3f2fd;"></div>
                            <span>Vacation/Leave</span>
                        </div>
                        <div class="status-item">
                            <div class="status-color" style="background-color: #e8f5e9;"></div>
                            <span>Day Off</span>
                        </div>
                        <div class="status-item">
                            <div class="status-color" style="background-color: #ffebee;"></div>
                            <span>NB (06:00-19:00)</span>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered" id="roster-table">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Date</th>
                                    <th>Shift</th>
                                    <th>Status</th>
                                    <th>Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Roster data will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Attendance Tab -->
                <div class="tab-pane fade" id="attendance-tab-pane" role="tabpanel" aria-labelledby="attendance-tab" tabindex="0">
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="fas fa-chart-pie me-2"></i> Attendance Summary
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-primary fw-bold" id="summary-days-worked">0</div>
                                        <small class="text-muted">Days Worked</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-primary fw-bold" id="summary-total-hours">0</div>
                                        <small class="text-muted">Total Hours</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-primary fw-bold" id="summary-days-off">0</div>
                                        <small class="text-muted">Days Off</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-primary fw-bold" id="summary-overtime">0 hrs</div>
                                        <small class="text-muted">Overtime</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-table me-2"></i> Detailed Attendance
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="attendance-table">
                                    <thead>
                                        <tr>
                                            <th>Day</th>
                                            <th>Date</th>
                                            <th>Shift</th>
                                            <th>Hours</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Attendance data will be inserted here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payslip Tab -->
                <div class="tab-pane fade" id="payslip-tab-pane" role="tabpanel" aria-labelledby="payslip-tab" tabindex="0">
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="fas fa-money-bill-wave me-2"></i> Salary Summary
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-success fw-bold" id="salary-basic">AED 0</div>
                                        <small class="text-muted">Basic Salary</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-success fw-bold" id="salary-food">AED 0</div>
                                        <small class="text-muted">Food Allowance</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-success fw-bold" id="salary-work-nature">AED 0</div>
                                        <small class="text-muted">Work Nature</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="text-success fw-bold" id="salary-total">AED 0</div>
                                        <small class="text-muted">Net Salary</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary w-100" id="view-payslip-btn">
                                    <i class="fas fa-file-invoice me-1"></i> View Full Payslip
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i> Monthly Summary
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="monthly-summary-table">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Days</th>
                                            <th>Hours</th>
                                            <th>Salary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Monthly summary data will be inserted here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav no-print">
            <a href="#" class="nav-btn active" id="roster-nav-btn">
                <i class="fas fa-calendar-alt"></i>
                <span>Roster</span>
            </a>
            <a href="#" class="nav-btn" id="attendance-nav-btn">
                <i class="fas fa-calendar-check"></i>
                <span>Attendance</span>
            </a>
            <a href="#" class="nav-btn" id="payslip-nav-btn">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Payslip</span>
            </a>
        </div>
    </div>

    <!-- Payslip Modal -->
    <div class="modal fade" id="payslipModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Employee Payslip</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="payslipModalBody">
                    <!-- Payslip content will be inserted here by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="print-payslip-btn">
                        <i class="fas fa-print me-2"></i>Print Payslip
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBnJ0m0QnNyC4pnv-dBEgC3yiq65YPwZvM",
            authDomain: "weone-roster.firebaseapp.com",
            databaseURL: "https://weone-roster-default-rtdb.firebaseio.com",
            projectId: "weone-roster",
            storageBucket: "weone-roster.appspot.com",
            messagingSenderId: "335364720116",
            appId: "1:335364720116:web:ae669c448aba3788aca5a1",
            measurementId: "G-Z8MBXC4ZFR"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        
        // DOM elements
        const loadingDiv = document.querySelector('.loading');
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const employeeIdInput = document.getElementById('employee-id');
        const rememberMe = document.getElementById('remember-me');
        const logoutBtn = document.getElementById('logout-btn');
        const employeeName = document.getElementById('employee-name');
        const employeeDesignation = document.getElementById('employee-designation');
        const infoWeoneId = document.getElementById('info-weone-id');
        const infoDepartment = document.getElementById('info-department');
        const infoArea = document.getElementById('info-area');
        const summaryDaysWorked = document.getElementById('summary-days-worked');
        const summaryTotalHours = document.getElementById('summary-total-hours');
        const summaryDaysOff = document.getElementById('summary-days-off');
        const summaryOvertime = document.getElementById('summary-overtime');
        const salaryBasic = document.getElementById('salary-basic');
        const salaryFood = document.getElementById('salary-food');
        const salaryWorkNature = document.getElementById('salary-work-nature');
        const salaryTotal = document.getElementById('salary-total');
        const viewPayslipBtn = document.getElementById('view-payslip-btn');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const monthDisplay = document.getElementById('month-display');
        const rosterTable = document.getElementById('roster-table');
        const rosterTableBody = rosterTable.querySelector('tbody');
        const attendanceTable = document.getElementById('attendance-table');
        const attendanceTableBody = attendanceTable.querySelector('tbody');
        const monthlySummaryTable = document.getElementById('monthly-summary-table');
        const monthlySummaryTableBody = monthlySummaryTable.querySelector('tbody');
        const payslipModal = new bootstrap.Modal(document.getElementById('payslipModal'));
        const payslipModalBody = document.getElementById('payslipModalBody');
        const printPayslipBtn = document.getElementById('print-payslip-btn');
        
        // Navigation buttons
        const rosterNavBtn = document.getElementById('roster-nav-btn');
        const attendanceNavBtn = document.getElementById('attendance-nav-btn');
        const payslipNavBtn = document.getElementById('payslip-nav-btn');
        const rosterTabPane = document.getElementById('roster-tab-pane');
        const attendanceTabPane = document.getElementById('attendance-tab-pane');
        const payslipTabPane = document.getElementById('payslip-tab-pane');

        // Global variables
        let currentEmployee = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let employeeData = {};
        let rosterData = [];
        let attendanceData = {};
        let salaryData = {};
        let monthlyStats = [];
        let attendanceChart = null;
        let hoursChart = null;
        let shiftChart = null;
        const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
        
        // Status options with colors
        const statusOptions = {
            'VI': { color: '#e3f2fd', description: 'Vacation/Leave' },
            'VJ': { color: '#fff8e1', description: 'Vacation/Job' },
            'YY': { color: '#e8f5e9', description: 'Day Off' },
            'NB': { color: '#ffebee', description: 'NB (06:00-19:00)' },
            'DF': { color: '#f3e5f5', description: 'DF (18:00-07:00)' },
            'EX': { color: '#e0f7fa', description: 'EX (08:00-20:00)' },
            'NR': { color: '#fff3e0', description: 'NR (20:00-08:00)' },
            'DX': { color: '#e8eaf6', description: 'DX (09:00-21:00)' },
            'NI': { color: '#f1f8e9', description: 'NI (21:00-09:00)' }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkRememberedLogin();
            setupEventListeners();
        });

        function checkRememberedLogin() {
            const rememberedId = localStorage.getItem('rememberedEmployeeId');
            if (rememberedId) {
                employeeIdInput.value = rememberedId;
                rememberMe.checked = true;
            }
        }

        function showLoading() {
            loadingDiv.style.display = 'flex';
        }

        function hideLoading() {
            loadingDiv.style.display = 'none';
        }

        function updateMonthDisplay() {
            monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Disable previous month button if we're at the earliest possible month
            const earliestMonth = new Date(2023, 0, 1); // January 2023 as earliest
            const currentDate = new Date(currentYear, currentMonth, 1);
            prevMonthBtn.disabled = currentDate <= earliestMonth;
        }

        function switchToPreviousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            
            showLoading();
            loadEmployeeData().then(() => {
                updateUI();
                hideLoading();
            });
        }

        function switchToNextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            
            showLoading();
            loadEmployeeData().then(() => {
                updateUI();
                hideLoading();
            });
        }

        function loadEmployeeData() {
            return new Promise((resolve) => {
                const monthYearKey = `${monthNames[currentMonth]}-${currentYear}`;
                
                // Load employee master data
                database.ref('employees').once('value').then((snapshot) => {
                    const allEmployees = snapshot.val();
                    
                    // Find employee by WE ONE ID or EK ID
                    let foundEmployee = null;
                    let department = null;
                    
                    Object.keys(allEmployees).forEach(dept => {
                        Object.keys(allEmployees[dept]).forEach(empId => {
                            const emp = allEmployees[dept][empId];
                            if (emp.weoneId === currentEmployee || emp.ekId === currentEmployee) {
                                foundEmployee = emp;
                                department = dept;
                            }
                        });
                    });
                    
                    if (!foundEmployee) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Employee not found. Please check your ID and try again.'
                        });
                        logout();
                        resolve();
                        return;
                    }
                    
                    employeeData = foundEmployee;
                    employeeData.department = department;
                    
                    // Load roster data
                    database.ref(`rosters/${department}/${monthYearKey}/${employeeData.weoneId}`).once('value').then((rosterSnapshot) => {
                        const rosterDataFromDB = rosterSnapshot.val();
                        
                        if (rosterDataFromDB) {
                            rosterData = rosterDataFromDB.days || [];
                        } else {
                            rosterData = [];
                        }
                        
                        // Load attendance data
                        database.ref(`attendance/${department}/${monthYearKey}/${employeeData.weoneId}`).once('value').then((attendanceSnapshot) => {
                            attendanceData = attendanceSnapshot.val() || {};
                            
                            // Load salary data
                            database.ref(`salaries/${department}/${monthYearKey}/${employeeData.weoneId}`).once('value').then((salarySnapshot) => {
                                salaryData = salarySnapshot.val() || {};
                                
                                // Load salary settings for this designation
                                database.ref(`salarySettings/${department}/${employeeData.designation}`).once('value').then((settingsSnapshot) => {
                                    const settings = settingsSnapshot.val();
                                    
                                    if (settings) {
                                        // If no salary data exists, initialize with settings
                                        if (!salaryData.basicSalary) {
                                            salaryData.basicSalary = settings.basicSalary || 2000;
                                            salaryData.foodAllowance = settings.foodAllowance || 300;
                                            salaryData.workNatureAllowance = settings.workNatureAllowance || 200;
                                        }
                                    }
                                    
                                    // Load monthly stats
                                    loadMonthlyStats().then(() => {
                                        resolve();
                                    });
                                }).catch(() => {
                                    // If no settings found, use defaults
                                    if (!salaryData.basicSalary) {
                                        salaryData.basicSalary = 2000;
                                        salaryData.foodAllowance = 300;
                                        salaryData.workNatureAllowance = 200;
                                    }
                                    
                                    loadMonthlyStats().then(() => {
                                        resolve();
                                    });
                                });
                            }).catch((error) => {
                                console.error("Error loading salary data:", error);
                                salaryData = {};
                                loadMonthlyStats().then(() => {
                                    resolve();
                                });
                            });
                        }).catch((error) => {
                            console.error("Error loading attendance data:", error);
                            attendanceData = {};
                            salaryData = {};
                            loadMonthlyStats().then(() => {
                                resolve();
                            });
                        });
                    }).catch((error) => {
                        console.error("Error loading roster data:", error);
                        rosterData = [];
                        attendanceData = {};
                        salaryData = {};
                        loadMonthlyStats().then(() => {
                            resolve();
                        });
                    });
                }).catch((error) => {
                    console.error("Error loading employee data:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load employee data. Please try again.'
                    });
                    resolve();
                });
            });
        }

        function loadMonthlyStats() {
            return new Promise((resolve) => {
                monthlyStats = [];
                const promises = [];
                
                // Get data for last 12 months
                for (let i = 0; i < 12; i++) {
                    const date = new Date(currentYear, currentMonth - i, 1);
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    const monthYearKey = `${monthNames[month]}-${year}`;
                    
                    promises.push(
                        database.ref(`salaries/${employeeData.department}/${monthYearKey}/${employeeData.weoneId}`).once('value').then((snapshot) => {
                            const data = snapshot.val();
                            if (data) {
                                monthlyStats.push({
                                    month,
                                    year,
                                    daysWorked: data.daysWorked || 0,
                                    totalHours: data.totalHours || 0,
                                    overtime: data.overtime || 0,
                                    total: data.total || 0
                                });
                            }
                        }).catch(() => {
                            // Ignore errors for months with no data
                        })
                    );
                }
                
                Promise.all(promises).then(() => {
                    // Sort by year and month (newest first)
                    monthlyStats.sort((a, b) => {
                        if (a.year !== b.year) return b.year - a.year;
                        return b.month - a.month;
                    });
                    resolve();
                });
            });
        }

        function updateUI() {
            updateMonthDisplay();
            
            // Update employee info
            employeeName.textContent = employeeData.name || '';
            employeeDesignation.textContent = employeeData.designation || '';
            infoWeoneId.textContent = employeeData.weoneId || '';
            infoDepartment.textContent = employeeData.department || '';
            infoArea.textContent = employeeData.area || '';
            
            // Calculate current month stats
            calculateCurrentMonthStats();
            
            // Update salary info
            salaryBasic.textContent = `AED ${(salaryData.basicSalary || 0).toFixed(2)}`;
            salaryFood.textContent = `AED ${(salaryData.foodAllowance || 0).toFixed(2)}`;
            salaryWorkNature.textContent = `AED ${(salaryData.workNatureAllowance || 0).toFixed(2)}`;
            
            const totalEarnings = (salaryData.basicSalary || 0) + 
                                 (salaryData.foodAllowance || 0) + 
                                 (salaryData.workNatureAllowance || 0) + 
                                 (salaryData.overtime || 0) + 
                                 (salaryData.specialReward || 0);
            const totalDeductions = (salaryData.eidDeduction || 0) + 
                                   (salaryData.advancedSalary || 0);
            const netSalary = totalEarnings - totalDeductions;
            
            salaryTotal.textContent = `AED ${netSalary.toFixed(2)}`;
            
            // Render tables
            renderRosterTable();
            renderAttendanceTable();
            renderMonthlySummaryTable();
        }

        function calculateCurrentMonthStats() {
            let daysWorked = 0;
            let totalHours = 0;
            let daysOff = 0;
            let absents = 0;
            let overtimeHours = 0;
            
            // Calculate from roster and attendance data
            if (rosterData && rosterData.length > 0) {
                rosterData.forEach((status, dayIndex) => {
                    // Skip if status is vacation/leave
                    if (status === 'VI' || status === 'VJ') {
                        daysOff++;
                        return;
                    }
                    
                    if (status === 'YY') {
                        daysOff++;
                        return;
                    }
                    
                    // Check attendance data for this day
                    const attendanceRecord = attendanceData[dayIndex];
                    
                    if (attendanceRecord) {
                        const hours = parseFloat(attendanceRecord.hours) || 0;
                        if (hours > 0) {
                            daysWorked++;
                            totalHours += hours;
                            
                            // Calculate overtime (simplified - any hours over 8 is overtime)
                            if (hours > 8) {
                                overtimeHours += (hours - 8);
                            }
                        } else {
                            absents++;
                        }
                    } else {
                        // No attendance record - assume absent
                        absents++;
                    }
                });
            }
            
            // Update summary cards
            summaryDaysWorked.textContent = daysWorked;
            summaryTotalHours.textContent = totalHours.toFixed(1);
            summaryDaysOff.textContent = daysOff;
            summaryOvertime.textContent = `${overtimeHours.toFixed(1)} hrs`;
        }

        function renderRosterTable() {
            rosterTableBody.innerHTML = '';
            
            if (!rosterData || rosterData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No roster data available for this month</td>';
                rosterTableBody.appendChild(row);
                return;
            }
            
            // Get number of days in current month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            for (let i = 0; i < daysInMonth; i++) {
                const date = new Date(currentYear, currentMonth, i + 1);
                const dayName = dayNames[date.getDay()];
                const status = rosterData[i] || 'YY';
                const statusInfo = statusOptions[status] || statusOptions['YY'];
                
                // Get attendance record for this day
                const attendanceRecord = attendanceData[i];
                let hoursWorked = '';
                let attendanceStatus = '';
                
                if (attendanceRecord) {
                    const hours = parseFloat(attendanceRecord.hours) || 0;
                    if (hours > 0) {
                        hoursWorked = hours;
                    } else {
                        hoursWorked = '<span class="absent-text">Absent</span>';
                    }
                } else {
                    hoursWorked = '<span class="absent-text">Absent</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dayName}</td>
                    <td>${i + 1}</td>
                    <td>${statusInfo.description}</td>
                    <td class="status-cell" style="background-color: ${statusInfo.color}">
                        ${status}
                    </td>
                    <td>${hoursWorked}</td>
                `;
                
                rosterTableBody.appendChild(row);
            }
        }

        function renderAttendanceTable() {
            attendanceTableBody.innerHTML = '';
            
            if (!rosterData || rosterData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No attendance data available for this month</td>';
                attendanceTableBody.appendChild(row);
                return;
            }
            
            // Get number of days in current month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            for (let i = 0; i < daysInMonth; i++) {
                const date = new Date(currentYear, currentMonth, i + 1);
                const dayName = dayNames[date.getDay()];
                const status = rosterData[i] || 'YY';
                const statusInfo = statusOptions[status] || statusOptions['YY'];
                
                // Skip days off and vacations
                if (status === 'YY' || status === 'VI' || status === 'VJ') continue;
                
                // Get attendance record for this day
                const attendanceRecord = attendanceData[i];
                let hoursWorked = '';
                let attendanceStatus = '';
                
                if (attendanceRecord) {
                    const hours = parseFloat(attendanceRecord.hours) || 0;
                    if (hours > 0) {
                        hoursWorked = hours;
                        attendanceStatus = 'Present';
                    } else {
                        hoursWorked = '<span class="absent-text">Absent</span>';
                        attendanceStatus = '<span class="absent-text">Absent</span>';
                    }
                } else {
                    hoursWorked = '<span class="absent-text">Absent</span>';
                    attendanceStatus = '<span class="absent-text">Absent</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dayName}</td>
                    <td>${i + 1}</td>
                    <td>${statusInfo.description}</td>
                    <td>${hoursWorked}</td>
                    <td>${attendanceStatus}</td>
                `;
                
                attendanceTableBody.appendChild(row);
            }
            
            if (attendanceTableBody.children.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No working days this month</td>';
                attendanceTableBody.appendChild(row);
            }
        }

        function renderMonthlySummaryTable() {
            monthlySummaryTableBody.innerHTML = '';
            
            if (monthlyStats.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" class="text-center">No salary data available</td>';
                monthlySummaryTableBody.appendChild(row);
                return;
            }
            
            monthlyStats.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${monthNames[stat.month].substring(0, 3)} ${stat.year}</td>
                    <td>${stat.daysWorked}</td>
                    <td>${stat.totalHours.toFixed(1)}</td>
                    <td>AED ${stat.total.toFixed(2)}</td>
                `;
                monthlySummaryTableBody.appendChild(row);
            });
        }

        function showPayslip() {
            if (!salaryData.basicSalary) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Salary Data',
                    text: 'Salary information is not available for this month.'
                });
                return;
            }
            
            const monthYear = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Calculate net pay
            const totalEarnings = (salaryData.basicSalary || 0) + 
                                 (salaryData.foodAllowance || 0) + 
                                 (salaryData.workNatureAllowance || 0) + 
                                 (salaryData.overtime || 0) + 
                                 (salaryData.specialReward || 0);
            const totalDeductions = (salaryData.eidDeduction || 0) + 
                                   (salaryData.advancedSalary || 0);
            const netPay = totalEarnings - totalDeductions;
            
            payslipModalBody.innerHTML = `
                <div class="payslip">
                    <div class="payslip-header">
                        <div class="payslip-title">PAYROLL INFORMATION</div>
                        <div class="payslip-period">Payment Period: ${monthYear}</div>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="payslip-section-title">Personal Information</div>
                        <div class="payslip-row">
                            <div class="payslip-label">Employee Name</div>
                            <div class="payslip-value">${employeeData.name || ''}</div>
                        </div>
                        <div class="payslip-row">
                            <div class="payslip-label">Employee Number</div>
                            <div class="payslip-value">${employeeData.weoneId || ''}</div>
                        </div>
                        <div class="payslip-row">
                            <div class="payslip-label">Organization</div>
                            <div class="payslip-value">WeOne</div>
                        </div>
                        <div class="payslip-row">
                            <div class="payslip-label">Position</div>
                            <div class="payslip-value">${employeeData.designation || ''}</div>
                        </div>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="payslip-section-title">Summary of Payment</div>
                        <table class="payslip-table">
                            <tr>
                                <th>Total Earnings</th>
                                <th>Total Deductions</th>
                                <th>Net Pay</th>
                            </tr>
                            <tr>
                                <td>AED ${totalEarnings.toFixed(2)}</td>
                                <td>AED ${totalDeductions.toFixed(2)}</td>
                                <td>AED ${netPay.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="payslip-section-title">Earnings</div>
                        <table class="payslip-table">
                            <tr>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                            <tr>
                                <td>Basic Salary</td>
                                <td>AED ${(salaryData.basicSalary || 0).toFixed(2)}</td>
                                <td>EID Charges</td>
                                <td>AED ${(salaryData.eidDeduction || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Food Allowance</td>
                                <td>AED ${(salaryData.foodAllowance || 0).toFixed(2)}</td>
                                <td>Advanced Salary</td>
                                <td>AED ${(salaryData.advancedSalary || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Work Nature Allowance</td>
                                <td>AED ${(salaryData.workNatureAllowance || 0).toFixed(2)}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Overtime</td>
                                <td>AED ${(salaryData.overtime || 0).toFixed(2)}</td>
                                <td>Total Deductions</td>
                                <td>AED ${totalDeductions.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td>Special Reward</td>
                                <td>AED ${(salaryData.specialReward || 0).toFixed(2)}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr class="total-row">
                                <td>Total Earnings</td>
                                <td>AED ${totalEarnings.toFixed(2)}</td>
                                <td></td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="payslip-section-title">Information</div>
                        <table class="payslip-table">
                            <tr>
                                <th>Description</th>
                                <th>Input Value</th>
                                <th>Value</th>
                            </tr>
                            <tr>
                                <td>Annual Leave Balance</td>
                                <td>Number of Days</td>
                                <td>34.08</td>
                            </tr>
                            <tr>
                                <td>Annual Leave Balance</td>
                                <td>Credited Upto</td>
                                <td>31-03-2025</td>
                            </tr>
                            <tr>
                                <td>Overtime</td>
                                <td>Normal Hours</td>
                                <td>${(salaryData.overtime / (salaryData.basicSalary / 200)).toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="payslip-section-title">Payment Information</div>
                        <table class="payslip-table">
                            <tr>
                                <th>Method</th>
                                <th>Bank Name</th>
                                <th>Branch Name</th>
                                <th>Account Number</th>
                                <th>Amount</th>
                            </tr>
                            <tr>
                                <td>Bank Transfer</td>
                                <td>EMIRATES NBD</td>
                                <td>DUBAI</td>
                                <td>••••••••••••••••6951</td>
                                <td>AED ${netPay.toFixed(2)}</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4">Total</td>
                                <td>AED ${netPay.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="payslip-footer">
                        <p>This is a computer generated payslip and does not require a signature.</p>
                        <p>Printed on: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            `;
            
            payslipModal.show();
        }

        function printCurrentPayslip() {
            const payslipContent = payslipModalBody.innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = payslipContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reinitialize event listeners
            setupEventListeners();
            
            // Re-show the payslip modal
            payslipModal.show();
        }

        function login() {
            const employeeId = employeeIdInput.value.trim();
            
            if (!employeeId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please enter your WE ONE ID or EK ID'
                });
                return;
            }
            
            showLoading();
            
            // Check if employee exists
            database.ref('employees').once('value').then((snapshot) => {
                const allEmployees = snapshot.val();
                let foundEmployee = null;
                
                Object.keys(allEmployees).forEach(dept => {
                    Object.keys(allEmployees[dept]).forEach(empId => {
                        const emp = allEmployees[dept][empId];
                        if (emp.weoneId === employeeId || emp.ekId === employeeId) {
                            foundEmployee = emp;
                        }
                    });
                });
                
                if (!foundEmployee) {
                    hideLoading();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Employee not found. Please check your ID and try again.'
                    });
                    return;
                }
                
                // Remember login if checkbox is checked
                if (rememberMe.checked) {
                    localStorage.setItem('rememberedEmployeeId', employeeId);
                } else {
                    localStorage.removeItem('rememberedEmployeeId');
                }
                
                // Set current employee and load data
                currentEmployee = employeeId;
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                
                loadEmployeeData().then(() => {
                    updateUI();
                    hideLoading();
                });
            }).catch((error) => {
                hideLoading();
                console.error("Error loading employee data:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load employee data. Please try again.'
                });
            });
        }

        function logout() {
            currentEmployee = null;
            employeeData = {};
            rosterData = [];
            attendanceData = {};
            salaryData = {};
            monthlyStats = [];
            
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            
            // Reset form
            loginForm.reset();
        }

        function switchTab(tabName) {
            // Hide all tab panes
            rosterTabPane.classList.remove('show', 'active');
            attendanceTabPane.classList.remove('show', 'active');
            payslipTabPane.classList.remove('show', 'active');
            
            // Remove active class from all nav buttons
            rosterNavBtn.classList.remove('active');
            attendanceNavBtn.classList.remove('active');
            payslipNavBtn.classList.remove('active');
            
            // Show selected tab and mark button as active
            switch(tabName) {
                case 'roster':
                    rosterTabPane.classList.add('show', 'active');
                    rosterNavBtn.classList.add('active');
                    break;
                case 'attendance':
                    attendanceTabPane.classList.add('show', 'active');
                    attendanceNavBtn.classList.add('active');
                    break;
                case 'payslip':
                    payslipTabPane.classList.add('show', 'active');
                    payslipNavBtn.classList.add('active');
                    break;
            }
        }

        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // Logout button
            logoutBtn.addEventListener('click', logout);
            
            // Month navigation buttons
            prevMonthBtn.addEventListener('click', switchToPreviousMonth);
            nextMonthBtn.addEventListener('click', switchToNextMonth);
            
            // View payslip button
            viewPayslipBtn.addEventListener('click', showPayslip);
            
            // Print payslip button
            printPayslipBtn.addEventListener('click', printCurrentPayslip);
            
            // Navigation buttons
            rosterNavBtn.addEventListener('click', function(e) {
                e.preventDefault();
                switchTab('roster');
            });
            
            attendanceNavBtn.addEventListener('click', function(e) {
                e.preventDefault();
                switchTab('attendance');
            });
            
            payslipNavBtn.addEventListener('click', function(e) {
                e.preventDefault();
                switchTab('payslip');
            });
        }
    </script>
</body>
</html>
